// ä¿å­˜ç•¶å‰çš„åˆªé™¤å›èª¿å‡½æ•¸
let currentDeleteCallback = null;

// ç•¶å‰é¸ä¸­çš„æœŸæ•¸
let currentPeriod = 1;

// å¾ localStorage ç²å–ä¿å­˜çš„æ›¸ç±è³‡æ–™ï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨é è¨­è³‡æ–™
let books = JSON.parse(localStorage.getItem('books')) || [
    {
        id: 1,
        period: 1,
        title: "è’¼é·ºèˆ‡å°‘å¹´",
        author: "å®®å´é§¿",
        presenter: "å°èŠ±",
        summary: "ä¸€å€‹é—œæ–¼æˆé•·ã€å‹èª¼èˆ‡ç’°ä¿çš„æ•…äº‹",
        reviews: [
            {
                id: 1,
                reviewer: "å°æ˜",
                rating: 5,
                comment: "é€™æ˜¯ä¸€éƒ¨å……æ»¿æƒ³åƒåŠ›çš„ä½œå“ï¼Œæ¢è¨äº†äººèˆ‡è‡ªç„¶çš„é—œä¿‚ã€‚\n\nç‰¹åˆ¥å–œæ­¡è£¡é¢å°ç’°å¢ƒè­°é¡Œçš„æ¢è¨ï¼Œä»¥åŠä¸»è§’èˆ‡è’¼é·ºä¹‹é–“çš„äº’å‹•ã€‚",
                fullReviewUrl: "reviews/review1.html"
            },
            {
                id: 2,
                reviewer: "å°è¯",
                rating: 4,
                comment: "æ•…äº‹æƒ…ç¯€å¼•äººå…¥å‹ï¼Œä½†çµå±€ç¨å«Œå€‰ä¿ƒã€‚",
                fullReviewUrl: "reviews/review2.html"
            }
        ]
    },
    {
        id: 2,
        period: 1,
        title: "æŒªå¨çš„æ£®æ—",
        author: "æ‘ä¸Šæ˜¥æ¨¹",
        presenter: "å°å¤©",
        summary: "é’æ˜¥ã€æ„›æƒ…èˆ‡å¤±è½çš„æ•…äº‹",
        reviews: [
            {
                id: 3,
                reviewer: "å°ç¾",
                rating: 5,
                comment: "éå¸¸è§¸å‹•äººå¿ƒçš„æ•…äº‹ï¼Œæå¯«å¾—å¾ˆç´°è†©ã€‚",
                fullReviewUrl: "reviews/review3.html"
            }
        ]
    },
    {
        id: 3,
        period: 5,
        title: "åŸå­ç¿’æ…£",
        author: "è©¹å§†æ–¯ï¼å…‹åˆ©çˆ¾",
        presenter: "é˜¿æ™º",
        summary: "é€™æ˜¯ä¸€æœ¬é—œæ–¼ç¿’æ…£é¤Šæˆçš„å¯¦ç”¨æŒ‡å—ã€‚\n\næ›¸ä¸­è©³ç´°è§£é‡‹äº†å¥½ç¿’æ…£çš„é¤Šæˆéç¨‹ï¼Œä¸¦æä¾›äº†è¨±å¤šå¯¦ç”¨çš„æ–¹æ³•å’ŒæŠ€å·§ã€‚\n\nä½œè€…ä»¥ç§‘å­¸ç ”ç©¶ç‚ºåŸºç¤ï¼Œèªªæ˜äº†å¾®å°æ”¹è®Šå¦‚ä½•ç´¯ç©æˆå·¨å¤§çš„æˆæœã€‚",
        reviews: [
            {
                id: 4,
                reviewer: "å°ç‰",
                rating: 5,
                comment: "é€™æœ¬æ›¸å¾¹åº•æ”¹è®Šäº†æˆ‘å°ç¿’æ…£é¤Šæˆçš„èªçŸ¥ï¼\n\nç‰¹åˆ¥å–œæ­¡æ›¸ä¸­æåˆ°çš„ã€Œ1% æ”¹å–„æ³•å‰‡ã€ï¼Œè®“æˆ‘æ˜ç™½æŒçºŒå°æ”¹è®Šçš„é‡è¦æ€§ã€‚",
                fullReviewUrl: "reviews/review4.html"
            },
            {
                id: 5,
                reviewer: "å¤§é›„",
                rating: 4,
                comment: "å…§å®¹å¾ˆå¯¦ç”¨ï¼Œä½†æœ‰äº›éƒ¨åˆ†ç•¥é¡¯é‡è¤‡ã€‚\nä¸éæ•´é«”ä¾†èªªå€¼å¾—ä¸€è®€ï¼Œå°¤å…¶æ˜¯é—œæ–¼ç’°å¢ƒè¨­è¨ˆå°ç¿’æ…£é¤Šæˆçš„å½±éŸ¿é‚£ä¸€ç« ã€‚",
                fullReviewUrl: "reviews/review5.html"
            },
            {
                id: 6,
                reviewer: "éœé¦™",
                comment: "é€™æœ¬æ›¸çµ¦äº†æˆ‘å¾ˆå¤šå•Ÿç™¼ï¼Œç‰¹åˆ¥æ˜¯åœ¨å»ºç«‹æ–°ç¿’æ…£çš„æ–¹æ³•ä¸Šã€‚é›–ç„¶æˆ‘é‚„æ²’å®Œå…¨å¯¦è¸ï¼Œä½†å·²ç¶“é–‹å§‹æŒ‰ç…§æ›¸ä¸­çš„å»ºè­°åšä¸€äº›æ”¹è®Šäº†ã€‚",
                fullReviewUrl: "reviews/review6.html"
            }
        ]
    }
];

// åˆå§‹åŒ–é é¢
document.addEventListener('DOMContentLoaded', () => {
    // æ¸…é™¤èˆŠè³‡æ–™ï¼ˆå¦‚æœéœ€è¦é‡ç½®è³‡æ–™ï¼Œå–æ¶ˆä¸‹é¢é€™è¡Œçš„è¨»è§£ï¼‰
    // localStorage.removeItem('books');
    
    // è¨­ç½®ç•¶å‰æœŸæ•¸ç‚º 5ï¼Œä»¥é¡¯ç¤ºç¯„ä¾‹è³‡æ–™
    currentPeriod = 5;
    
    setupPeriodNavigation();
    displayBooks();
    setupEventListeners();
    
    // æ›´æ–°æœŸæ•¸æŒ‰éˆ•çš„æ´»å‹•ç‹€æ…‹
    document.querySelectorAll('.period-btn').forEach(btn => {
        if (parseInt(btn.dataset.period) === currentPeriod) {
            btn.classList.add('active');
        }
    });
});

// è¨­ç½®æœŸæ•¸å°èˆª
function setupPeriodNavigation() {
    document.querySelector('.period-nav').addEventListener('click', (e) => {
        if (e.target.classList.contains('period-btn')) {
            // æ›´æ–°æ´»å‹•ç‹€æ…‹
            document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');
            
            // æ›´æ–°ç•¶å‰æœŸæ•¸ä¸¦é‡æ–°é¡¯ç¤ºæ›¸ç±
            currentPeriod = parseInt(e.target.dataset.period);
            displayBooks();
        }
    });
}

// é¡¯ç¤ºæ›¸ç±åˆ—è¡¨
function displayBooks() {
    const bookList = document.getElementById('bookList');
    const filteredBooks = books.filter(book => book.period === currentPeriod);
    // è¨ˆç®—å¹³å‡è©•åˆ†çš„å‡½æ•¸
    function calculateAverageRating(reviews) {
        const ratingsWithoutNull = reviews.filter(review => review.rating !== null);
        if (ratingsWithoutNull.length === 0) return null;
        const sum = ratingsWithoutNull.reduce((acc, review) => acc + review.rating, 0);
        return (sum / ratingsWithoutNull.length).toFixed(1);
    }

    // ç”Ÿæˆæ˜Ÿæ˜Ÿè©•åˆ†çš„HTML
    function generateStarRating(rating) {
        if (rating === null) return '';
        const fullStars = Math.floor(rating);
        const hasHalfStar = rating - fullStars >= 0.5;
        const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
        
        return `
            ${'â˜…'.repeat(fullStars)}${hasHalfStar ? 'â¯¨' : ''}${'â˜†'.repeat(emptyStars)}
            <span class="rating-number">${rating}</span>
        `;
    }

    bookList.innerHTML = filteredBooks.map(book => {
        return `
        <div class="book-card" data-book-id="${book.id}">
            <button class="delete-button delete-book-button" data-book-id="${book.id}">åˆªé™¤</button>
            <h2 class="book-title">${book.title}</h2>
            <p class="book-author">ä½œè€…ï¼š${book.author}</p>
            <p class="book-presenter">å‡ºæ›¸äººï¼š${book.presenter}</p>
            <p class="book-summary">${book.summary}</p>
            <p class="review-count">ğŸ“š ${book.reviews.length} å‰‡è©•åƒ¹</p>
        </div>
    `}).join('');
}

// è¨­ç½®äº‹ä»¶ç›£è½å™¨
function setupEventListeners() {
    // æ›¸ç±å¡ç‰‡é»æ“Šäº‹ä»¶
    document.getElementById('bookList').addEventListener('click', (e) => {
        console.log('Card clicked', e.target);
        
        if (e.target.classList.contains('delete-book-button')) {
            console.log('Delete button clicked');
            e.stopPropagation();
            const bookId = parseInt(e.target.dataset.bookId);
            showConfirmDialog('ç¢ºå®šè¦åˆªé™¤é€™æœ¬æ›¸å—ï¼Ÿ', () => deleteBook(bookId));
        } else {
            const bookCard = e.target.closest('.book-card');
            console.log('Found book card:', bookCard);
            
            if (bookCard && !e.target.classList.contains('delete-book-button')) {
                e.preventDefault();
                const bookId = parseInt(bookCard.dataset.bookId);
                console.log('Opening details for book ID:', bookId);
                showBookDetails(bookId);
            }
        }
    });

    // æ–°å¢æ›¸ç±æŒ‰éˆ•é»æ“Šäº‹ä»¶
    document.getElementById('addBookBtn').addEventListener('click', () => {
        document.getElementById('addBookForm').classList.remove('hidden');
    });

    // é—œé–‰æŒ‰éˆ•äº‹ä»¶
    document.querySelectorAll('.close-button').forEach(button => {
        button.addEventListener('click', (e) => {
            e.target.closest('.modal, .book-details').classList.add('hidden');
        });
    });

    // é»æ“ŠèƒŒæ™¯é—œé–‰æ¨¡æ…‹æ¡†
    document.querySelectorAll('.modal, .book-details').forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.add('hidden');
            }
        });
    });

    // æ–°å¢æ›¸ç±è¡¨å–®æäº¤äº‹ä»¶
    document.getElementById('bookForm').addEventListener('submit', (e) => {
        e.preventDefault();
            const newBook = {
                id: books.length > 0 ? Math.max(...books.map(b => b.id)) + 1 : 1,
                period: parseInt(document.getElementById('bookPeriod').value),
                title: document.getElementById('bookTitle').value,
                author: document.getElementById('bookAuthor').value,
                presenter: document.getElementById('bookPresenter').value,
                summary: document.getElementById('bookSummary').value,
                reviews: []
            };        books.push(newBook);
        saveBooks();
        displayBooks();
        document.getElementById('addBookForm').classList.add('hidden');
        document.getElementById('bookForm').reset();
    });

    // æ–°å¢è©•è«–è¡¨å–®æäº¤äº‹ä»¶
    document.getElementById('reviewForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const bookId = parseInt(document.getElementById('reviewBookId').value);
        const book = books.find(b => b.id === bookId);
        
        if (book) {
            const linkValue = document.getElementById('reviewLink').value;
            
            const newReview = {
                id: book.reviews.length > 0 ? Math.max(...book.reviews.map(r => r.id)) + 1 : 1,
                reviewer: document.getElementById('reviewerName').value,
                comment: document.getElementById('reviewComment').value,
                fullReviewUrl: linkValue || null
            };
            
            book.reviews.push(newReview);
            saveBooks();
            showBookDetails(bookId);
            document.getElementById('addReviewForm').classList.add('hidden');
            document.getElementById('reviewForm').reset();
        }
    });

    // è©•è«–åˆªé™¤æŒ‰éˆ•äº‹ä»¶
    document.getElementById('bookDetails').addEventListener('click', (e) => {
        if (e.target.classList.contains('delete-review-button')) {
            const bookId = parseInt(e.target.dataset.bookId);
            const reviewId = parseInt(e.target.dataset.reviewId);
            showConfirmDialog('ç¢ºå®šè¦åˆªé™¤é€™å‰‡è©•è«–å—ï¼Ÿ', () => deleteReview(bookId, reviewId));
        }
    });

    // ç¢ºèªå°è©±æ¡†æŒ‰éˆ•äº‹ä»¶
    document.getElementById('confirmDelete').addEventListener('click', () => {
        if (typeof currentDeleteCallback === 'function') {
            currentDeleteCallback();
        }
        document.getElementById('confirmDialog').classList.add('hidden');
    });

    document.getElementById('cancelDelete').addEventListener('click', () => {
        document.getElementById('confirmDialog').classList.add('hidden');
    });
}

// é¡¯ç¤ºç¢ºèªå°è©±æ¡†
function showConfirmDialog(message, callback) {
    const dialog = document.getElementById('confirmDialog');
    document.getElementById('confirmMessage').textContent = message;
    currentDeleteCallback = callback;
    dialog.classList.remove('hidden');
}

// åˆªé™¤æ›¸ç±
function deleteBook(bookId) {
    const index = books.findIndex(b => b.id === bookId);
    if (index !== -1) {
        books.splice(index, 1);
        saveBooks();
        displayBooks();
        document.getElementById('bookDetails').classList.add('hidden');
    }
}

// åˆªé™¤è©•è«–
function deleteReview(bookId, reviewId) {
    const book = books.find(b => b.id === bookId);
    if (book) {
        const reviewIndex = book.reviews.findIndex(r => r.id === reviewId);
        if (reviewIndex !== -1) {
            book.reviews.splice(reviewIndex, 1);
            saveBooks();
            showBookDetails(bookId);
        }
    }
}

// ä¿å­˜æ›¸ç±è³‡æ–™åˆ° localStorage
function saveBooks() {
    localStorage.setItem('books', JSON.stringify(books));
}

// é¡¯ç¤ºæ›¸ç±è©³ç´°è³‡è¨Š
function showBookDetails(bookId) {
    console.log('showBookDetails called with ID:', bookId);
    const book = books.find(b => b.id === bookId);
    
    if (!book) {
        console.error('Book not found with ID:', bookId);
        console.log('Available books:', books);
        return;
    }
    
    console.log('Found book:', book);
    
    const bookDetails = document.getElementById('bookDetails');
    console.log('Book details element:', bookDetails);
    
    if (!bookDetails) {
        console.error('Could not find bookDetails element');
        return;
    }

    try {
        const averageRating = calculateAverageRating(book.reviews);
        console.log('Average rating:', averageRating);
        
    const detailsContent = `
        <div class="book-details-content">
            <button class="close-button">&times;</button>
            <h2>${book.title}</h2>
            <p>ä½œè€…ï¼š${book.author}</p>
            <p>å‡ºæ›¸äººï¼š${book.presenter}</p>
            <h3>è®€è€…è©•åƒ¹</h3>
            <div class="review-list">
                ${book.reviews.map(review => `
                    <div class="review-item">
                        <button class="delete-button delete-review-button" data-book-id="${book.id}" data-review-id="${review.id}">åˆªé™¤</button>
                        <p>
                            <strong>${review.reviewer}</strong>
                        </p>
                        <p>${review.comment}</p>
                        ${review.fullReviewUrl ? `<a href="${review.fullReviewUrl}" target="_blank">é–±è®€å®Œæ•´å¿ƒå¾—</a>` : ''}
                    </div>
                `).join('')}
            </div>
            <button class="add-review-button" data-book-id="${book.id}">æ–°å¢è©•è«–</button>
        </div>
    `;        console.log('Setting innerHTML');
        bookDetails.innerHTML = detailsContent;
        console.log('innerHTML set successfully');

        console.log('Removing hidden class');
        bookDetails.classList.remove('hidden');
        console.log('Hidden class removed');

        // è¨­ç½®é—œé–‰æŒ‰éˆ•äº‹ä»¶
        const closeButton = bookDetails.querySelector('.close-button');
        console.log('Close button found:', closeButton);
        
        if (closeButton) {
            closeButton.addEventListener('click', (e) => {
                console.log('Close button clicked');
                e.stopPropagation();
                bookDetails.classList.add('hidden');
            });
        }

        // é»æ“ŠèƒŒæ™¯é—œé–‰
        bookDetails.addEventListener('click', (e) => {
            console.log('Background clicked', e.target);
            if (e.target === bookDetails) {
                console.log('Adding hidden class');
                bookDetails.classList.add('hidden');
            }
        });

        // é˜²æ­¢é»æ“Šå…§å®¹å€åŸŸæ™‚é—œé–‰
        const content = bookDetails.querySelector('.book-details-content');
        if (content) {
            content.addEventListener('click', (e) => {
                console.log('Content clicked');
                e.stopPropagation();
            });
        }

        // æ–°å¢è©•è«–æŒ‰éˆ•äº‹ä»¶
        const addReviewButton = bookDetails.querySelector('.add-review-button');
        console.log('Add review button found:', addReviewButton);
        
        if (addReviewButton) {
            addReviewButton.addEventListener('click', (e) => {
                console.log('Add review button clicked');
                e.stopPropagation();
                document.getElementById('reviewBookId').value = bookId;
                document.getElementById('addReviewForm').classList.remove('hidden');
            });
        }
        
        console.log('All event listeners set up successfully');
    } catch (error) {
        console.error('Error in showBookDetails:', error);
    }
}

    // é€™éƒ¨åˆ†å·²ç¶“åœ¨ä¸Šé¢çš„ try-catch å€å¡Šä¸­è™•ç†éäº†
}